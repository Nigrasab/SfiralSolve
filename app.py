import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import re
import io

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–µ—Ä–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
st.set_page_config(page_title="–°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è –∫–≤–∞–Ω—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞", layout="centered")

# –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
st.markdown("<div style='text-align:center; font-size:18px;'>–ù–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –§–æ–Ω–¥ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∏—Ä–æ–¥—ã –≤—Ä–µ–º–µ–Ω–∏</div>", unsafe_allow_html=True)

# –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
st.title("–°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è –∫–≤–∞–Ω—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞")

# –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
with st.expander("‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ"):
    st.markdown("""
        –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. 
        –û–Ω–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Ç—Ä–∞–∂–∞—é—â–∏—Ö –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–∏.

        **–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
        - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
        - –ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç –¥–∞—ë—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ —É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ñ–æ—Ä–º (—É–∑–ª–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å –º—ã—à–ª–µ–Ω–∏–µ, —Å–æ–∑–Ω–∞–Ω–∏–µ –∏–ª–∏ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.
        - –°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏, –∫–∞–∫ —ç—Ç–æ –±—ã–≤–∞–µ—Ç –≤ –ø–∞–º—è—Ç–∏, —Å–Ω–µ, –∏–Ω—Ç—É–∏—Ü–∏–∏.

        **–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:** `.json`, –ø–æ–ª–µ `statevector`. 
        **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:** 5 –ú–ë.
    """)

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
st.markdown("### üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏–π")
uploaded_file = st.file_uploader("–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞", type="json", help="–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 5 –ú–ë –Ω–∞ —Ñ–∞–π–ª ‚Ä¢ JSON")

if uploaded_file:
    try:
        df = pd.read_json(uploaded_file)

        if len(df) > 50000:
            st.warning("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –†–∞–∑–¥–µ–ª–∏—Ç–µ –µ–≥–æ –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
        else:
            df_counts = df["statevector"].value_counts().reset_index()
            df_counts.columns = ["–°–æ—Å—Ç–æ—è–Ω–∏–µ", "–ß–∞—Å—Ç–æ—Ç–∞"]

            # –§–∏–ª—å—Ç—Ä –ø–æ —à–∞–±–ª–æ–Ω—É
            pattern_input = st.text_input("üîç –§–∏–ª—å—Ç—Ä –ø–æ –±–∏—Ç–æ–≤–æ–º—É —à–∞–±–ª–æ–Ω—É (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ * –¥–ª—è –ª—é–±—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π):", value="")
            if pattern_input:
                try:
                    regex = re.compile("^" + pattern_input.replace("*", ".") + "$")
                    df_counts = df_counts[df_counts["–°–æ—Å—Ç–æ—è–Ω–∏–µ"].apply(lambda x: bool(regex.match(x)))]
                except re.error:
                    st.error("–ù–µ–≤–µ—Ä–Ω—ã–π —à–∞–±–ª–æ–Ω —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.")

            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            sort_order = st.radio("–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —á–∞—Å—Ç–æ—Ç–µ:", ["–ü–æ —É–±—ã–≤–∞–Ω–∏—é", "–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é"], horizontal=True)
            ascending = sort_order == "–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é"
            df_counts = df_counts.sort_values("–ß–∞—Å—Ç–æ—Ç–∞", ascending=ascending)

            # –°–ª–∞–π–¥–µ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            top_n = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π:", min_value=1, max_value=50, value=min(10, len(df_counts)))
            df_top = df_counts.head(top_n)

            # –ì—Ä–∞—Ñ–∏–∫
            fig, ax = plt.subplots(figsize=(10, 4))
            sns.barplot(x="–°–æ—Å—Ç–æ—è–Ω–∏–µ", y="–ß–∞—Å—Ç–æ—Ç–∞", data=df_top, palette="Blues_r", ax=ax)
            ax.set_title("–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–æ–ø-{} —Å–æ—Å—Ç–æ—è–Ω–∏–π".format(top_n))
            ax.set_xlabel("–°–æ—Å—Ç–æ—è–Ω–∏–µ")
            ax.set_ylabel("–ß–∞—Å—Ç–æ—Ç–∞")
            plt.xticks(rotation=45)
            st.pyplot(fig)

            # –¢–∞–±–ª–∏—Ü–∞
            st.dataframe(df_top, use_container_width=True)

            # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV
            csv_buffer = io.BytesIO()
            df_top.to_csv(csv_buffer, index=False)
            st.download_button(
                label="üíæ –°–∫–∞—á–∞—Ç—å CSV",
                data=csv_buffer.getvalue(),
                file_name="—Ç–æ–ø_—Å–æ—Å—Ç–æ—è–Ω–∏–π.csv",
                mime="text/csv"
            )

            # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ PNG
            img_buffer = io.BytesIO()
            plt.savefig(img_buffer, format='png')
            img_buffer.seek(0)
            st.download_button(
                label="üñº –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ PNG",
                data=img_buffer,
                file_name="–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞_—Å–æ—Å—Ç–æ—è–Ω–∏–π.png",
                mime="image/png"
            )

            # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            st.markdown("""
                ---
                #### üß† –°–º—ã—Å–ª–æ–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞–∏–±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤—ã–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è. –≠—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–∂–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ **—É–∑–ª—ã –°—Ñ–∏—Ä–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**, –æ—Ç—Ä–∞–∂–∞—é—â–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö. 

                –¢–∞–∫–∏–µ —É–∑–ª—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∞–Ω–∞–ª–æ–≥–∞–º–∏ **–ø–µ—Ä–µ—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–∑ –≤ –º—ã—à–ª–µ–Ω–∏–∏**, **—É—Å—Ç–æ–π—á–∏–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤ —Å–æ–∑–Ω–∞–Ω–∏—è** –∏–ª–∏ –¥–∞–∂–µ **–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –Ω–µ—Ä–≤–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö).

                –ê–Ω–∞–ª–∏–∑ –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–æ–º–æ–≥–∞–µ—Ç –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –ø—Ä–∏—Ä–æ–¥—É **–∏–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü–∏–∏, —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏**. 
            """)

            st.success("\u0414–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!")

    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
