import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import io
import re

st.set_page_config(page_title="–°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è –∫–≤–∞–Ω—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞", layout="centered")

st.markdown("""
<p style='text-align: center; font-size:20px;'><strong>–ù–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –§–æ–Ω–¥ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∏—Ä–æ–¥—ã –≤—Ä–µ–º–µ–Ω–∏</strong></p>
<h1 style='text-align: center;'>–°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è –∫–≤–∞–Ω—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
""", unsafe_allow_html=True)

st.markdown("""
### üìò –û –ø—Ä–æ–µ–∫—Ç–µ
–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. –û–Ω–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Ç—Ä–∞–∂–∞—é—â–∏—Ö –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∏—Ö —Å–≤—è–∑—å —Å –º–æ–¥–µ–ª—è–º–∏ –º—ã—à–ª–µ–Ω–∏—è, —Å–æ–∑–Ω–∞–Ω–∏—è –∏ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏. 

–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ ‚Äî `.json`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–¥ –∫–ª—é—á–æ–º `statevector`. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: **5 –ú–ë**.
""")

uploaded_file = st.file_uploader("üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏–π", type="json")

if uploaded_file:
    try:
        df = pd.read_json(uploaded_file)

        if len(df) > 50000:
            st.warning("‚ö†Ô∏è–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –†–∞–∑–¥–µ–ª–∏—Ç–µ –µ–≥–æ –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
        else:
            df_counts = df["statevector"].value_counts().reset_index()
            df_counts.columns = ["–°–æ—Å—Ç–æ—è–Ω–∏–µ", "–ß–∞—Å—Ç–æ—Ç–∞"]

            pattern_input = st.text_input("üîç –§–∏–ª—å—Ç—Ä –ø–æ –±–∏—Ç–æ–≤–æ–º—É —à–∞–±–ª–æ–Ω—É (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ * –¥–ª—è –ª—é–±—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π):", value="")
            if pattern_input:
                try:
                    regex = re.compile("^" + pattern_input.replace("*", ".") + "$")
                    df_counts = df_counts[df_counts["–°–æ—Å—Ç–æ—è–Ω–∏–µ"].apply(lambda x: bool(regex.match(x)))]
                except re.error:
                    st.error("–ù–µ–≤–µ—Ä–Ω—ã–π —à–∞–±–ª–æ–Ω —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.")

            sort_order = st.radio("–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —á–∞—Å—Ç–æ—Ç–µ:", ["–ü–æ —É–±—ã–≤–∞–Ω–∏—é", "–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é"], horizontal=True)
            ascending = sort_order == "–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é"

            max_states = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π:", 1, min(50, len(df_counts)), 10)

            df_top = df_counts.sort_values("–ß–∞—Å—Ç–æ—Ç–∞", ascending=ascending).head(max_states)

            fig, ax = plt.subplots(figsize=(10, 4))
            sns.barplot(x="–°–æ—Å—Ç–æ—è–Ω–∏–µ", y="–ß–∞—Å—Ç–æ—Ç–∞", data=df_top, palette="Blues_r", ax=ax)
            plt.xticks(rotation=45)
            st.pyplot(fig)

            st.dataframe(df_top, use_container_width=True)

            # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV
            csv_buffer = io.BytesIO()
            df_top.to_csv(csv_buffer, index=False)
            st.download_button(
                label="üì• –°–∫–∞—á–∞—Ç—å CSV",
                data=csv_buffer.getvalue(),
                file_name="—Ç–æ–ø_—Å–æ—Å—Ç–æ—è–Ω–∏–π.csv",
                mime="text/csv"
            )

            # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ PNG
            img_buffer = io.BytesIO()
            plt.savefig(img_buffer, format='png')
            img_buffer.seek(0)
            st.download_button(
                label="üñº –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ PNG",
                data=img_buffer,
                file_name="–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞_—Å–æ—Å—Ç–æ—è–Ω–∏–π.png",
                mime="image/png"
            )

            st.success("‚úÖ–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!")

            top_state = df_counts.iloc[0]["–°–æ—Å—Ç–æ—è–Ω–∏–µ"]

            st.markdown("""
---
### üí† –°—Ñ–∏—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
**–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —É–∑–ª—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏:**

–≠—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –Ω–∞–∏–±–æ–ª—å—à—É—é –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å –≤ –∫–≤–∞–Ω—Ç–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ –∏ –º–æ–≥—É—Ç —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å—Å—è –∫–∞–∫ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω—ã–µ —è–∫–æ—Ä—è –°—Ñ–∏—Ä–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã. –ò—Ö —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤—É–µ—Ç –æ —Ä–∏—Ç–º–∏—á–µ—Å–∫–æ–π —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ—Å—Ç–∏.

–¢–∞–∫–∏–µ —É–∑–ª—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ **—Ç–æ—á–∫–∏ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è** –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π ‚Äî –ø–æ–¥–æ–±–Ω–æ —Ç–æ–º—É, –∫–∞–∫ –≤ –±–∏–æ–ª–æ–≥–∏–∏ —É—Å—Ç–æ–π—á–∏–≤—ã–µ —Ñ–æ—Ä–º—ã –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.

–≠—Ç–æ —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ ‚Äî –≥–¥–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —É–∑–ª—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –ø—É–ª—å—Å –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ—Ç—Ä–∞–∂–∞—é—Ç –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –º—ã—à–ª–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–Ω–∞–Ω–∏—è.

üîπ **–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ `{}`**  
–≠—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–º–µ–µ—Ç **–Ω–∞–∏–±–æ–ª—å—à—É—é —á–∞—Å—Ç–æ—Ç—É –ø–æ—è–≤–ª–µ–Ω–∏—è** —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –¢–æ –µ—Å—Ç—å, –æ–Ω–æ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —á–∞—â–µ –¥—Ä—É–≥–∏—Ö, **—á—Ç–æ —Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤—É–µ—Ç –æ –µ–≥–æ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏**, –∫–∞–∫ –µ—Å–ª–∏ –±—ã —Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ "–ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–ª–∞" –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–µ–º—É. –≠—Ç–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è **—É–∑–ª–æ–≤ —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞ –∏–ª–∏ —è–∫–æ—Ä–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**.

üîπ **–ü–æ—á–µ–º—É –æ–Ω–æ —Å—Ñ–∏—Ä–∞–ª—å–Ω–æ–µ**  
–ü–æ—Å–∫–æ–ª—å–∫—É –°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ –∏ –∞–Ω—Ç–∏—Å–∏–º–º–µ—Ç—Ä–∏—é, —Å–æ—Å—Ç–æ—è–Ω–∏–µ `{}` –º–æ–∂–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ **–æ–¥–∏–Ω –∏–∑ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω—ã—Ö –∫–ª—é—á–µ–π**, –≤ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω **—É–∑–µ–ª —Å–º–µ–Ω—ã –ø–æ—Ä—è–¥–∫–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞**. –¢–∞–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–≥—É—Ç **—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç–∏** –≤–æ –≤—Ä–µ–º–µ–Ω–∏, –∏ –Ω–∞ —ç—Ç–æ–º –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –º—ã –∏—Ö –Ω–∞–∑—ã–≤–∞–µ–º **—Å—Ñ–∏—Ä–∞–ª—å–Ω—ã–º–∏**, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–æ—è—Ç–Ω—ã–º–∏.

üîπ **–ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç**
- –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç **–≤–∏–∑—É–∞–ª—å–Ω–æ –∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏** –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
- –î–∞—ë—Ç **—Ç–æ—á–∫—É –æ–ø–æ—Ä—ã** –¥–ª—è —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—Å–µ–π —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –°—Ñ–∏—Ä–∞–ª–∏.
- –ú–æ–∂–µ—Ç —Å–ª—É–∂–∏—Ç—å **–æ—Å–Ω–æ–≤–æ–π –¥–ª—è –±–∏–æ–º–æ–¥–µ–ª–µ–π, –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–∑–Ω–∞–Ω–∏—è –∏–ª–∏ –∫–≤–∞–Ω—Ç–æ–≤–æ–π –ø–∞–º—è—Ç–∏**, –µ—Å–ª–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å —ç—Ç—É –ª–∏–Ω–∏—é.

```text
{}
```
""".format(top_state, top_state, top_state))

    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {e}")
