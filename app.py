import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import io
import re

st.set_page_config(page_title="–°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è –∫–≤–∞–Ω—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞", layout="centered")

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
st.markdown("""
# –°—Ñ–∏—Ä–∞–ª—å–Ω–∞—è –∫–≤–∞–Ω—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
### –ù–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –§–æ–Ω–¥ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∏—Ä–æ–¥—ã –≤—Ä–µ–º–µ–Ω–∏

#### –û –ø—Ä–æ–µ–∫—Ç–µ
–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤. –û–Ω–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Ç—Ä–∞–∂–∞—é—â–∏—Ö –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∏—Ö —Å–≤—è–∑—å —Å –º–æ–¥–µ–ª—è–º–∏ –º—ã—à–ª–µ–Ω–∏—è, —Å–æ–∑–Ω–∞–Ω–∏—è –∏ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏. –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ ‚Äî `.json`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å–ø–∏—Å–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–¥ –∫–ª—é—á–æ–º `statevector`. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 5 –ú–ë**.

#### –°–º—ã—Å–ª –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –∫–≤–∞–Ω—Ç–æ–≤–æ–π —Å—Ö–µ–º—ã. –≠—Ç–æ **–º–æ–¥–µ–ª—å –°—Ñ–∏—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü–∏–∏**, –æ—Ç—Ä–∞–∂–∞—é—â–∞—è:  
- –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∫–∞–∫ –∞–Ω–∞–ª–æ–≥ –º—ã—à–ª–µ–Ω–∏—è,  
- —É—Å—Ç–æ–π—á–∏–≤—ã–µ —É–∑–ª—ã –∫–∞–∫ —Ç–æ—á–∫–∏ —Å–∞–º–æ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è (–∞–Ω–∞–ª–æ–≥ –ø–∞–º—è—Ç–∏),  
- —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞–∫ —Å–ª–µ–¥ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∏.  

**–£–∑–ª—ã** ‚Äî —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—â–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è. –û–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —É—Å—Ç–æ–π—á–∏–≤—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∞–Ω–∞–ª–æ–≥–∏–µ–π —É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ —Å–æ–∑–Ω–∞–Ω–∏–∏, –±–∏–æ—Ä–∏—Ç–º–∞—Ö –∏–ª–∏ –¥–∏–Ω–∞–º–∏–∫–µ –≤—Ä–µ–º–µ–Ω–∏.
""")

uploaded_file = st.file_uploader("–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞", type="json")

if uploaded_file:
    if uploaded_file.size > 5 * 1024 * 1024:
        st.error("‚ùå –§–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 5 –ú–ë.")
    else:
        try:
            df = pd.read_json(uploaded_file)
            if len(df) > 50000:
                st.warning("‚ö†Ô∏è –§–∞–π–ª –¥–æ–≤–æ–ª—å–Ω–æ –±–æ–ª—å—à–æ–π, –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑–¥–µ–ª–∏—Ç—å –µ–≥–æ.")
            else:
                df_counts = df["statevector"].value_counts().reset_index()
                df_counts.columns = ["–°–æ—Å—Ç–æ—è–Ω–∏–µ", "–ß–∞—Å—Ç–æ—Ç–∞"]

                pattern_input = st.text_input("üîç –§–∏–ª—å—Ç—Ä –ø–æ –±–∏—Ç–æ–≤–æ–º—É —à–∞–±–ª–æ–Ω—É (* –¥–ª—è –ª—é–±—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π):", value="")
                if pattern_input:
                    try:
                        regex = re.compile("^" + pattern_input.replace("*", ".") + "$")
                        df_counts = df_counts[df_counts["–°–æ—Å—Ç–æ—è–Ω–∏–µ"].apply(lambda x: bool(regex.match(x)))]
                    except re.error:
                        st.error("–ù–µ–≤–µ—Ä–Ω—ã–π —à–∞–±–ª–æ–Ω —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.")

                sort_order = st.radio("–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —á–∞—Å—Ç–æ—Ç–µ:", ["–ü–æ —É–±—ã–≤–∞–Ω–∏—é", "–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é"], horizontal=True)
                ascending = (sort_order == "–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é")
                df_counts = df_counts.sort_values("–ß–∞—Å—Ç–æ—Ç–∞", ascending=ascending)

                max_display = min(50, len(df_counts))
                top_n = st.slider("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π:", 1, max_display, 10)
                df_top = df_counts.head(top_n)

                fig, ax = plt.subplots(figsize=(10, 4))
                sns.barplot(x="–°–æ—Å—Ç–æ—è–Ω–∏–µ", y="–ß–∞—Å—Ç–æ—Ç–∞", data=df_top, palette="Blues_r", ax=ax)
                ax.set_title(f"–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–æ–ø-{top_n} —Å–æ—Å—Ç–æ—è–Ω–∏–π")
                ax.set_xlabel("–°–æ—Å—Ç–æ—è–Ω–∏–µ")
                ax.set_ylabel("–ß–∞—Å—Ç–æ—Ç–∞")
                plt.xticks(rotation=45)
                st.pyplot(fig)

                st.dataframe(df_top, use_container_width=True)

                csv_buffer = io.BytesIO()
                df_top.to_csv(csv_buffer, index=False)
                st.download_button(
                    label="‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å CSV",
                    data=csv_buffer.getvalue(),
                    file_name="—Ç–æ–ø_—Å–æ—Å—Ç–æ—è–Ω–∏–π.csv",
                    mime="text/csv"
                )

                img_buffer = io.BytesIO()
                plt.savefig(img_buffer, format="png")
                img_buffer.seek(0)
                st.download_button(
                    label="üñºÔ∏è –°–∫–∞—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ PNG",
                    data=img_buffer,
                    file_name="–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞_—Å–æ—Å—Ç–æ—è–Ω–∏–π.png",
                    mime="image/png"
                )

                st.success("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!")

                st.markdown("""
### üí° –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
–í—ã—è–≤–ª–µ–Ω–Ω—ã–µ —É–∑–ª—ã ‚Äî —ç—Ç–æ —É—Å—Ç–æ–π—á–∏–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã, —á–∞—Å—Ç–æ –ø—Ä–æ—è–≤–ª—è—é—â–∏–µ—Å—è –≤ –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏—è—Ö. –û–Ω–∏ –º–æ–≥—É—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –∞–Ω–∞–ª–æ–≥–∏ –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö –ø–∏–∫–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ä–∏—Ç–º–æ–≤ –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è.

–°–∞–º–∞ –º–æ–¥–µ–ª—å –æ—Ç—Ä–∞–∂–∞–µ—Ç **—Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ-–∏–Ω—Ç–µ—Ä—Ñ–µ—Ä–µ–Ω—Ü–∏–æ–Ω–Ω—É—é –ø—Ä–∏—Ä–æ–¥—É –≤—Ä–µ–º–µ–Ω–∏**, –≥–¥–µ –°—Ñ–∏—Ä–∞–ª—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é, –∞ **—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤**. –≠—Ç–æ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –Ω–∞—Å –∫ –ø–æ–Ω–∏–º–∞–Ω–∏—é –Ω–µ —Ç–æ–ª—å–∫–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, –Ω–æ –∏ —Å–∞–º–æ–≥–æ **–ø—Ä–æ—Ü–µ—Å—Å–∞ –º—ã—à–ª–µ–Ω–∏—è** –∫–∞–∫ –∫–≤–∞–Ω—Ç–æ–≤–æ-—Ñ–∞–∑–æ–≤–æ–π –¥–∏–Ω–∞–º–∏–∫–∏.
""")

        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
